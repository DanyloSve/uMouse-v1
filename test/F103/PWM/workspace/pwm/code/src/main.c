#include <stdio.h>

#include "stm32f10x.h"

#include "timer_delays.h"

// https://arm-stm.blogspot.com/2014/12/timer-pwm-mode.html
//----------------------------------------------------------
void RCC_init(void);
void GPIO_init(void);
void PWM_TIM4_Init(void);

void TIM4_Init(void);
void PWM_TIM2_Init(void);

void setPWM(uint16_t frequency, uint16_t filling);

int main(void)
{	
	char str[16];
	float angle = 0;
	
	//RCC_init();
	//delays_init(72);
	
	PWM_TIM2_Init();
	PWM_TIM4_Init();
	
	GPIO_init();
	//delay_ms(500);
	
  while(1)
  {
		
	}
}
//----------------------------------------------------------

void TIM4_Init(void)
{
	
}

void PWM_TIM2_Init(void)
{
	RCC->APB2ENR |= (RCC_APB2ENR_IOPAEN | RCC_APB2ENR_AFIOEN); //???????????? ????? GPIOA ? ?????????????? ???????
  GPIOA->CRL |= GPIO_CRL_MODE1;//???????????? ???????? ????? = 50 MHz
  GPIOA->CRL &= ~GPIO_CRL_CNF1;//??????? ??? CNF[1:0] ??? PA1 (????????? ????? ?????? ?? ????? ????? "Input Floating")
  GPIOA->CRL |= GPIO_CRL_CNF1_1; //PA1 - ????? Push-Pull ? ?????? ?????????????? ???????

  /*????????????? ??????? TIM2
  ??? ???????????? ??????? ??? ???????????? ????? 2 (TIM2_CH2)*/
  RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;//???????????? ??????? TIM2
  TIM2->CR1 |= TIM_CR1_ARPE;//??????? ????? ??????????????? ?????? ???????? ????????????????
  TIM2->CCMR1 |= TIM_CCMR1_OC2PE;//??????? ????? ??????????????? ???????? ???????? ?????????
  TIM2->CCMR1 |= (TIM_CCMR1_OC2M_2 | TIM_CCMR1_OC2M_1);//OC2M = 110 - PWM mode 1
  TIM2->ARR = 23999;//?????? ????????? ??????? T = 1mS
  TIM2->CCR2 = 19200;//???????????? ????????. ? ?????? ?????? Duty cycle = 80%
  //TIM2->CCER |= TIM_CCER_CC2P;//?????????? ????????? ???????
  TIM2->CCER |= TIM_CCER_CC2E;//????? ?????? ???????/????????? ???????
  TIM2->CR1 |= TIM_CR1_CEN;//????? ????? ???????
}

void PWM_TIM4_Init(void)
{
	// using tim4 channel 1 - PB6

	// PB6 init
	RCC->APB2ENR |= RCC_APB2ENR_IOPBEN;
	RCC->APB2ENR |= RCC_APB2ENR_AFIOEN;
	RCC->APB1ENR |= RCC_APB1ENR_TIM4EN;
	
	GPIOB->CRL |= GPIO_CRL_MODE6; // output max 50 MHz
	
	GPIOB->CRL &= ~GPIO_CRL_CNF6;
	GPIOB->CRL |= GPIO_CRL_CNF6_1; // afio push-pull	
	
	GPIOB->CRL |= GPIO_CRL_MODE7; // output max 50 MHz
	
	GPIOB->CRL &= ~GPIO_CRL_CNF7;
	GPIOB->CRL |= GPIO_CRL_CNF7_1; // afio push-pull	
	
	// 
	//RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;//???????????? ??????? TIM2
  TIM4->CR1 |= TIM_CR1_ARPE;//??????? ????? ??????????????? ?????? ???????? ????????????????
  TIM4->CCMR1 |= TIM_CCMR1_OC2PE;//??????? ????? ??????????????? ???????? ???????? ?????????
  TIM4->CCMR1 |= (TIM_CCMR1_OC2M_2 | TIM_CCMR1_OC2M_1);//OC2M = 110 - PWM mode 1
  
	TIM4->ARR = 23999;//?????? ????????? ??????? T = 1mS
  TIM4->CCR2 = 19200;//???????????? ????????. ? ?????? ?????? Duty cycle = 80%
  //TIM4->CCER |= TIM_CCER_CC2P;//?????????? ????????? ???????
  TIM4->CCER |= TIM_CCER_CC2E;//????? ?????? ???????/????????? ???????
	
	
	TIM4->CCMR1 |= TIM_CCMR1_OC1PE;
	TIM4->CCMR1 |= (TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1);
	TIM4->CCER |= TIM_CCER_CC1E;
	
	TIM4->CR1 |= TIM_CR1_CEN;//????? ????? ???????
	/*
	
	TIM4->CR1 &= ~TIM_CR1_CMS; // edge aligned mode
	TIM4->CR1 &= ~TIM_CR1_DIR; // upcounting
	TIM4->CR1 |= TIM_CR1_ARPE;
	
	TIM2->ARR = 23999;
	TIM2->CCR2 = 19200;
	
	TIM4->CCMR1 |=  TIM_CCMR1_OC1PE;
	TIM4->CCMR1 |=  (TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1);

	//TIM4->CCER |= TIM_CCER_CC1P; //  active high
	TIM4->CCER |= TIM_CCER_CC1E; // en
	

	TIM4->EGR |= TIM_EGR_UG; 
	TIM4->CR1 |= TIM_CR1_CEN;
	*/
}

void setPWM(uint16_t frequency, uint16_t filling)
{
	TIM4->ARR = frequency;
	TIM4->CCR1 = filling;
}

void RCC_init(void)
{
	RCC->CR |= ((uint32_t)RCC_CR_HSEON);
    
  while (!(RCC->CR & RCC_CR_HSERDY))
  {
    
  }
    
  FLASH->ACR = FLASH_ACR_PRFTBE | FLASH_ACR_LATENCY;
    
  RCC->CFGR |= RCC_CFGR_HPRE_DIV1;  // AHB
  RCC->CFGR |= RCC_CFGR_PPRE1_DIV1; // APB1
  RCC->CFGR |= RCC_CFGR_PPRE2_DIV1; // APB2
    
  RCC->CFGR |= RCC_CFGR_PLLSRC_HSE; // SOURCE HSE
  RCC->CFGR |= RCC_CFGR_PLLMULL9;   // PLL = 4 * 7 == 28
    
  RCC->CR |= RCC_CR_PLLON; // PLL EN
    
  while ((RCC->CR & RCC_CR_PLLRDY) == 0)
  {
   
  }
        
  RCC->CFGR &= ~RCC_CFGR_SW;
  RCC->CFGR |= RCC_CFGR_SW_PLL; // select source SYSCLK == PLL
    
  while ((RCC->CFGR & RCC_CFGR_SWS) != RCC_CFGR_SWS_1)
  {
    
  }
}

void GPIO_init(void)
{
	RCC->APB2ENR |= RCC_APB2ENR_IOPCEN; // enabling clock to C port
    
  GPIOC->CRH |= GPIO_CRH_CNF13_0;  // configure for push-up output 
  GPIOC->CRH |= GPIO_CRH_MODE13_0; // max clock freaquency 10MHz
}

